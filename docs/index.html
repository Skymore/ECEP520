<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>Elma: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Elma
   </div>
   <div id="projectbrief">An event loop manager for embedded systems</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Elma Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Elma is an event loop and process manager for embedded systems. It keeps track of processes, executes them at specified frequencies, and enables interprocess communication.</p>
<h2>Example </h2>
<p>As an example, we will develop a simple cruise control system in which we model a car with one process and a control system with another. The underlying mathematics look like this. Let <code>v</code> be the velocity of a car, <code>m</code> its mass, <code>k</code> the coefficient of rolling friction, and <code>u</code> the force being applied by the engine on the car. Then a very simplified model of the car's velocity comes from Newton's second law (<code>f = ma</code>): </p><pre class="fragment">m dv/dt = -k v + u
</pre><p>This is a continuous model, but our processes are discrete. We can discretize the model using the definition of derivative: </p><pre class="fragment">dv/dt = lim(h-&gt;0) (v(t) - v(t-h)) / h 
</pre><p>For <code>h</code> small, <code>dv/dt</code> is thus approximately </p><pre class="fragment">dv/dt = (v(t) - v(t-h)) / h
</pre><p>or </p><pre class="fragment">v(t) = v(t-h) + h dv/dt 
     = v(t-h) - h (k v - u)
</pre><p>In our case, <code>h</code> is given by the difference between the last update and the previous update, which is available to user processes via the <code>delta()</code> function. Thus, we can write </p><pre class="fragment">class Car : public elma::Process {
public:
    Car(std::string name) : Process(name) {}
    void init() {}
    void start() {
    velocity = 0;
    force = 0;
    }
    void update() {
    if ( channel("Throttle").nonempty() ) {
        force = channel("Throttle").latest();
    }
    velocity += ( delta() / 1000 ) * ( - k * velocity + force ) / m;
        velocity += ( delta() / 1000 ) * ( - k * velocity + force ) / m;
        channel("Velocity").send(velocity);
        std::cout &lt;&lt; "t: "  &lt;&lt; milli_time() &lt;&lt; " ms\t" 
                    &lt;&lt; " u: " &lt;&lt; force        &lt;&lt; " N\t"
                    &lt;&lt; " v: " &lt;&lt; velocity     &lt;&lt; " m/s\n";  
    }
    void stop() {}
private:
    double velocity;
    double force;
    const double k = 0.02;
    const double m = 1000;
}; 
</pre><p>A very simple controller uses proportional feedback. Basically, we set </p><pre class="fragment">u = - Kp ( v - vdes )
</pre><p>where <code>Kp</code> is the proportional gain and <code>vdes</code> is the desired velocity. To make a control process, we write </p><pre class="fragment">class CruiseControl : public elma::Process {
public:
    CruiseControl(std::string name) : Process(name) {}
    void init() {}
    void start() {
    speed = 0;
    }
    void update() {
    if ( channel("Velocity").nonempty() ) {
        speed = channel("Velocity").latest();
    }
    channel("Throttle").send(-KP*(speed - desired_speed));
    }
    void stop() {}
private:
    double speed;
    const double desired_speed = 50.0,
                KP = 250.0;
}; 
</pre><p>To set everything up, we add the two processes and the two channels to the manager, initialize everything, and run the system. </p><pre class="fragment">elma::Manager m;

Car car("Car");
CruiseControl cc("Control");
elma::Channel throttle("Throttle");
elma::Channel velocity("Velocity");

m.schedule(car, MS(10))
.schedule(cc, MS(10))
.add_channel(throttle)
.add_channel(velocity)
.init()
.run(MS(10000));
</pre><p>Note that the order of the scheduling is important. We want the controller to run right after the car. If we reversed the order, the controller would be using an older sensor value.</p>
<p>The output of the system for the first few steps looks like: </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 22 2019 17:35:23 for Elma by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
